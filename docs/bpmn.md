# 2.5. Модель в нотации BPMN

## Процесс «Регистрация пользователя»

```mermaid
flowchart LR
    subgraph pool ["Пользователь"]
        A1(("⚫"))
        A2["Открыть форму<br/>регистрации"]
        A3["Заполнить<br/>данные"]
        A4["Отправить<br/>форму"]
        A5["Получить письмо<br/>с подтверждением"]
        A6["Перейти по<br/>ссылке"]
        A7(("⊙"))
        
        A1 --> A2 --> A3 --> A4
        A4 --> A5 --> A6 --> A7
    end
    
    subgraph pool2 ["Система BookSwap"]
        B1["Валидация<br/>данных"]
        B2{"Данные<br/>корректны?"}
        B3["Показать<br/>ошибки"]
        B4["Создать<br/>аккаунт"]
        B5["Отправить<br/>email"]
        B6["Активировать<br/>аккаунт"]
        
        A4 --> B1 --> B2
        B2 -->|"Нет"| B3 --> A3
        B2 -->|"Да"| B4 --> B5
        A6 --> B6
    end
```

## Процесс «Добавление книги»

```mermaid
flowchart LR
    subgraph pool ["Пользователь"]
        A1(("⚫"))
        A2["Открыть форму<br/>добавления"]
        A3{"Есть<br/>ISBN?"}
        A4["Ввести ISBN"]
        A5["Заполнить<br/>вручную"]
        A6["Проверить<br/>данные"]
        A7["Загрузить<br/>фото"]
        A8["Сохранить"]
        A9(("⊙"))
        
        A1 --> A2 --> A3
        A3 -->|"Да"| A4
        A3 -->|"Нет"| A5
        A4 --> A6
        A5 --> A6
        A6 --> A7 --> A8 --> A9
    end
    
    subgraph pool2 ["Система BookSwap"]
        B1["Запросить<br/>OpenLibrary API"]
        B2{"Книга<br/>найдена?"}
        B3["Заполнить поля<br/>автоматически"]
        B4["Показать<br/>пустую форму"]
        B5["Сохранить в БД"]
        B6["Обновить<br/>каталог"]
        
        A4 --> B1 --> B2
        B2 -->|"Да"| B3 --> A6
        B2 -->|"Нет"| B4 --> A5
        A8 --> B5 --> B6
    end
```

## Процесс «Поиск книги»

```mermaid
flowchart LR
    subgraph pool ["Пользователь"]
        A1(("⚫"))
        A2["Ввести<br/>запрос"]
        A3["Настроить<br/>фильтры"]
        A4["Указать<br/>радиус поиска"]
        A5["Просмотреть<br/>результаты"]
        A6{"Найдена<br/>нужная?"}
        A7["Открыть<br/>карточку книги"]
        A8["Изменить<br/>параметры"]
        A9(("⊙"))
        
        A1 --> A2 --> A3 --> A4
        A4 --> A5 --> A6
        A6 -->|"Да"| A7 --> A9
        A6 -->|"Нет"| A8 --> A2
    end
    
    subgraph pool2 ["Система BookSwap"]
        B1["Полнотекстовый<br/>поиск"]
        B2["Применить<br/>фильтры"]
        B3["Геофильтрация"]
        B4["Ранжирование<br/>по рейтингу"]
        B5["Отобразить<br/>на карте"]
        
        A4 --> B1 --> B2 --> B3 --> B4 --> B5 --> A5
    end
```

## Процесс «Обмен книгами» (основной)

```mermaid
flowchart TB
    subgraph lane1 ["Инициатор"]
        A1(("⚫"))
        A2["Найти книгу"]
        A3["Отправить<br/>запрос на обмен"]
        A4["Ожидание<br/>ответа"]
        A5{"Запрос<br/>принят?"}
        A6["Согласовать<br/>детали в чате"]
        A7["Встретиться<br/>и обменять"]
        A8["Подтвердить<br/>получение"]
        A9["Оставить<br/>отзыв"]
        A10(("⊙"))
        A11(("⊗"))
        
        A1 --> A2 --> A3 --> A4 --> A5
        A5 -->|"Нет"| A11
        A5 -->|"Да"| A6 --> A7 --> A8 --> A9 --> A10
    end
    
    subgraph lane2 ["Владелец книги"]
        B1["Получить<br/>уведомление"]
        B2["Просмотреть<br/>профиль инициатора"]
        B3{"Принять<br/>запрос?"}
        B4["Отклонить"]
        B5["Принять"]
        B6["Согласовать<br/>детали в чате"]
        B7["Встретиться<br/>и обменять"]
        B8["Подтвердить<br/>передачу"]
        B9["Оставить<br/>отзыв"]
        B10(("⊙"))
        
        A3 --> B1 --> B2 --> B3
        B3 -->|"Нет"| B4 --> A5
        B3 -->|"Да"| B5 --> A5
        B5 --> B6 --> B7 --> B8 --> B9 --> B10
        A6 <-.-> B6
        A7 <-.-> B7
    end
    
    subgraph lane3 ["Система"]
        C1["Создать запрос"]
        C2["Отправить<br/>уведомление"]
        C3["Обновить статус"]
        C4["Сохранить<br/>сообщения"]
        C5["Зафиксировать<br/>обмен"]
        C6["Обновить<br/>рейтинги"]
        C7["Пометить книгу<br/>недоступной"]
        
        A3 --> C1 --> C2 --> B1
        B4 --> C3
        B5 --> C3
        A6 --> C4
        B6 --> C4
        A8 --> C5
        B8 --> C5
        C5 --> C7
        A9 --> C6
        B9 --> C6
    end
```

## Процесс «Модерация жалобы»

```mermaid
flowchart LR
    subgraph pool1 ["Пользователь"]
        A1(("⚫"))
        A2["Открыть профиль<br/>нарушителя"]
        A3["Отправить<br/>жалобу"]
        A4["Получить<br/>решение"]
        A5(("⊙"))
        
        A1 --> A2 --> A3 --> A4 --> A5
    end
    
    subgraph pool2 ["Модератор"]
        B1["Получить<br/>жалобу"]
        B2["Изучить<br/>контекст"]
        B3{"Нарушение<br/>есть?"}
        B4["Отклонить<br/>жалобу"]
        B5{"Тяжесть<br/>нарушения?"}
        B6["Вынести<br/>предупреждение"]
        B7["Заблокировать<br/>пользователя"]
        B8(("⊙"))
        
        A3 --> B1 --> B2 --> B3
        B3 -->|"Нет"| B4 --> A4
        B3 -->|"Да"| B5
        B5 -->|"Лёгкое"| B6 --> A4
        B5 -->|"Тяжёлое"| B7 --> A4
        B4 --> B8
        B6 --> B8
        B7 --> B8
    end
    
    subgraph pool3 ["Система"]
        C1["Зарегистрировать<br/>жалобу"]
        C2["Уведомить<br/>модератора"]
        C3["Применить<br/>санкции"]
        C4["Уведомить<br/>стороны"]
        
        A3 --> C1 --> C2 --> B1
        B6 --> C3 --> C4
        B7 --> C3
    end
```

## Комментарии к модели BPMN

### Процесс «Регистрация пользователя»

Описывает создание нового аккаунта с подтверждением email.

**Участники:**
- Пользователь — заполняет форму и подтверждает email
- Система — валидирует данные, создаёт аккаунт, отправляет письмо

**Ключевые точки:**
- Шлюз «Данные корректны?» — проверка на уникальность email, корректность пароля
- Активация происходит только после перехода по ссылке из письма

### Процесс «Добавление книги»

Демонстрирует два сценария: автозаполнение по ISBN и ручной ввод.

**Особенности:**
- Интеграция с OpenLibrary API для получения метаданных
- При отсутствии книги в API — ручное заполнение
- Возможность загрузки фотографий обложки и состояния книги

### Процесс «Поиск книги»

Показывает многоступенчатую фильтрацию с геолокацией.

**Этапы обработки в системе:**
1. Полнотекстовый поиск по названию/автору
2. Применение фильтров (жанр, состояние, язык)
3. Геофильтрация по радиусу от пользователя
4. Ранжирование по рейтингу владельца
5. Отображение результатов на карте

### Процесс «Обмен книгами»

Центральный бизнес-процесс платформы с тремя пулами участников.

**Инициатор:**
- Находит книгу → отправляет запрос → ожидает решения
- При положительном ответе — согласование, встреча, подтверждение, отзыв
- При отклонении — процесс завершается

**Владелец книги:**
- Получает уведомление → изучает профиль инициатора
- Принимает решение о передаче книги
- Параллельно с инициатором проходит этапы согласования и обмена

**Система:**
- Создаёт и хранит запрос
- Отправляет уведомления на каждом этапе
- Фиксирует завершение обмена и обновляет рейтинги
- Помечает книгу как недоступную

### Процесс «Модерация жалобы»

Описывает обработку нарушений правил платформы.

**Сценарии:**
- Жалоба отклонена — нарушения нет
- Лёгкое нарушение — предупреждение пользователю
- Тяжёлое нарушение — блокировка аккаунта

**Роль системы:**
- Регистрация жалобы и уведомление модератора
- Автоматическое применение санкций после решения
- Информирование обеих сторон о результате