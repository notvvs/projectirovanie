# 2.4. Фрагменты модели в нотации DFD

## Контекстная диаграмма (уровень 0)

```mermaid
flowchart TB
    U1[/"Пользователь"/]
    U2[/"Модератор"/]
    U3[/"Администратор"/]
    U4[/"Внешний API<br/>(OpenLibrary)"/]
    
    P0(("0<br/>Система<br/>BookSwap"))
    
    U1 -->|"Регистрация, данные профиля"| P0
    U1 -->|"Данные книги, запросы на обмен"| P0
    U1 -->|"Поисковые запросы"| P0
    U1 -->|"Оценки, отзывы"| P0
    
    P0 -->|"Результаты поиска"| U1
    P0 -->|"Уведомления"| U1
    P0 -->|"Подтверждения обмена"| U1
    P0 -->|"Сообщения чата"| U1
    
    U2 -->|"Решения по жалобам"| P0
    P0 -->|"Жалобы на модерацию"| U2
    
    U3 -->|"Настройки системы"| P0
    P0 -->|"Статистика, логи"| U3
    
    U4 -->|"Метаданные книги"| P0
    P0 -->|"Запрос по ISBN"| U4
```

## Диаграмма уровня 1 — Декомпозиция системы

```mermaid
flowchart TB
    U[/"Пользователь"/]
    API[/"Внешний API"/]
    
    D1[("D1: Пользователи")]
    D2[("D2: Книги")]
    D3[("D3: Обмены")]
    D4[("D4: Сообщения")]
    D5[("D5: Рейтинги")]
    
    P1(("1<br/>Управление<br/>аккаунтом"))
    P2(("2<br/>Управление<br/>книгами"))
    P3(("3<br/>Поиск"))
    P4(("4<br/>Обмен"))
    P5(("5<br/>Рейтинг"))
    
    U -->|"Регистрация/вход"| P1
    P1 -->|"Токен сессии"| U
    P1 <-->|"Профиль"| D1
    
    U -->|"Данные книги"| P2
    P2 -->|"ISBN"| API
    API -->|"Метаданные"| P2
    P2 <-->|"Записи книг"| D2
    
    U -->|"Поисковый запрос"| P3
    P3 -->|"Результаты"| U
    P3 -->|"Чтение"| D2
    P3 -->|"Чтение"| D5
    
    U -->|"Запрос на обмен"| P4
    P4 -->|"Уведомление"| U
    P4 <-->|"Записи обменов"| D3
    P4 <-->|"Чат"| D4
    P4 -->|"Обновление статуса"| D2
    
    P4 -->|"Завершённый обмен"| P5
    U -->|"Оценка, отзыв"| P5
    P5 <-->|"Записи рейтингов"| D5
    P5 -->|"Обновление рейтинга"| D1
```

## Фрагмент: Процесс «Обмен книгами» (уровень 2)

```mermaid
flowchart TB
    U1[/"Инициатор"/]
    U2[/"Владелец книги"/]
    
    D3[("D3: Обмены")]
    D4[("D4: Сообщения")]
    D2[("D2: Книги")]
    
    P41(("4.1<br/>Создание<br/>запроса"))
    P42(("4.2<br/>Обработка<br/>ответа"))
    P43(("4.3<br/>Согласование<br/>в чате"))
    P44(("4.4<br/>Подтверждение<br/>обмена"))
    
    U1 -->|"Запрос на книгу"| P41
    P41 -->|"Новый запрос"| D3
    P41 -->|"Уведомление о запросе"| U2
    
    U2 -->|"Принять/отклонить"| P42
    P42 -->|"Статус запроса"| D3
    P42 -->|"Уведомление о решении"| U1
    
    U1 -->|"Сообщение"| P43
    U2 -->|"Сообщение"| P43
    P43 <-->|"История чата"| D4
    P43 -->|"Новое сообщение"| U1
    P43 -->|"Новое сообщение"| U2
    
    U1 -->|"Подтверждение"| P44
    U2 -->|"Подтверждение"| P44
    P44 -->|"Статус: завершён"| D3
    P44 -->|"Книга недоступна"| D2
    P44 -->|"Запрос на оценку"| U1
    P44 -->|"Запрос на оценку"| U2
```

## Комментарии к модели DFD

### Контекстная диаграмма (уровень 0)

Показывает границы системы и её взаимодействие с внешними сущностями:

**Внешние сущности:**
- *Пользователь* — основной актор, выполняет большинство операций: регистрация, добавление книг, поиск, обмен, оценка
- *Модератор* — получает жалобы и выносит решения по спорным ситуациям
- *Администратор* — управляет настройками системы, получает статистику и логи
- *Внешний API (OpenLibrary)* — источник метаданных о книгах по ISBN

**Ключевые потоки данных:**
- Входящие от пользователя: регистрационные данные, информация о книгах, поисковые запросы, оценки
- Исходящие к пользователю: результаты поиска, уведомления, подтверждения, сообщения чата

### Диаграмма уровня 1

Система декомпозирована на пять основных процессов:

**Процесс 1: Управление аккаунтом**
Регистрация, аутентификация, редактирование профиля. Взаимодействует с хранилищем D1 (Пользователи). Выдаёт токен сессии для авторизации в других процессах.

**Процесс 2: Управление книгами**
Добавление, редактирование, удаление книг. Может запрашивать метаданные у внешнего API по ISBN. Работает с хранилищем D2 (Книги).

**Процесс 3: Поиск**
Принимает поисковый запрос, читает данные из хранилищ D2 (Книги) и D5 (Рейтинги) для ранжирования. Возвращает отсортированные результаты.

**Процесс 4: Обмен**
Центральный бизнес-процесс. Обрабатывает запросы на обмен, управляет чатом, фиксирует завершение сделки. Работает с хранилищами D3 (Обмены), D4 (Сообщения), обновляет статус в D2.

**Процесс 5: Рейтинг**
Собирает оценки после завершения обмена, рассчитывает средний рейтинг, обновляет данные в D5 (Рейтинги) и D1 (Пользователи).

**Хранилища данных:**
- D1: Пользователи — профили, учётные данные, рейтинг
- D2: Книги — каталог книг всех пользователей
- D3: Обмены — записи о запросах и их статусах
- D4: Сообщения — история чатов между пользователями
- D5: Рейтинги — оценки и отзывы

### Фрагмент уровня 2: Процесс «Обмен»

Детализация процесса 4 на четыре подпроцесса:

**4.1 Создание запроса** — инициатор выбирает книгу и отправляет запрос. Создаётся запись в D3, владельцу уходит уведомление.

**4.2 Обработка ответа** — владелец принимает или отклоняет запрос. Статус обновляется в D3, инициатор получает уведомление.

**4.3 Согласование в чате** — стороны обмениваются сообщениями для уточнения деталей (время, место). История сохраняется в D4.

**4.4 Подтверждение обмена** — обе стороны подтверждают факт обмена. Статус в D3 меняется на «завершён», книга помечается как недоступная в D2, обоим участникам отправляется запрос на оценку.